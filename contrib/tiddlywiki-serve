#!/usr/bin/env bash

#
# tiddlywiki-serve
#
# Start a TiddlyWiki server (running in a Docker container)
# for an //existing// wiki on the host's filesystem.
#

[[ -n $DEBUG ]] && set -o xtrace

readonly TIDDLYWIKI_DOCKER_TAG="${TIDDLYWIKI_DOCKER_TAG:-latest}"
readonly WIKIFOLDER=$1

if [[ -z $WIKIFOLDER ]] || [[ ! -d $WIKIFOLDER ]]; then
	printf 'Usage: tiddlywiki-serve <wikifolder>\n'
	exit 1
fi

# replace any invalid characters with a hyphen
container_name="tw-${WIKIFOLDER//[^a-zA-Z0-9_.-]/-}"

docker run --detach --rm \
	--name "$container_name" \
	--env-file <(env | grep ^TIDDLYWIKI_) \
	--publish 127.0.0.1::8080 \
	--mount "type=bind,source=${PWD},target=/tiddlywiki" \
	--user "$(id -u):$(id -g)" \
	"elasticdog/tiddlywiki:${TIDDLYWIKI_DOCKER_TAG}" \
	"$WIKIFOLDER" \
	--server 8080 '$:/core/save/lazy-all' text/plain text/html '' '' 0.0.0.0

if [[ $? -ne 0 ]]; then
	printf 'ERROR: could not start %s server\n' "$container_name"
	exit 1
fi

port_mapping=$(docker port "$container_name" 8080)
printf '%s server listening at %s\n' "$container_name" "http://${port_mapping/#127.0.0.1/localhost}"
